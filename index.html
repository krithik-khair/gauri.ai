<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gauri • Kritvya</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: radial-gradient(circle at bottom, #0b1a2b, #050505 60%);
  color: #cfcfcf;
  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.header {
  position: absolute;
  top: 18px;
  width: 100%;
  text-align: center;
  font-size: 0.7rem;
  letter-spacing: 0.35em;
  color: #6f86a6;
}

.app {
  text-align: center;
  width: 100%;
  max-width: 420px;
}

.orb-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 90px;
}

.orb {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #5aa9ff, #1b3c66 70%);
  box-shadow: 0 0 50px rgba(90,169,255,0.25);
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.orb:hover {
  transform: scale(1.05);
  box-shadow: 0 0 70px rgba(90,169,255,0.35);
}

.orb.listening {
  animation: pulse 2.2s infinite;
  box-shadow: 0 0 80px rgba(120,180,255,0.45);
  background: radial-gradient(circle at 30% 30%, #ff5a5a, #661b1b 70%);
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.06); }
  100% { transform: scale(1); }
}

.permission-warning {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  padding: 20px;
  border-radius: 10px;
  border: 1px solid #5aa9ff;
  max-width: 80%;
  z-index: 100;
  display: none;
}

.permission-warning.show {
  display: block;
}

.status {
  margin-top: 55px;
  font-size: 0.95rem;
  color: #9aa8bd;
  min-height: 40px;
  padding: 0 16px;
}

.footer {
  position: absolute;
  bottom: 24px;
  width: 100%;
  text-align: center;
  font-size: 0.75rem;
  color: #5f6f85;
}
</style>
</head>

<body>

<div class="header">GAURI • LIVE</div>

<div class="app">
  <div class="orb-wrapper">
    <div id="orb" class="orb"></div>
  </div>
  <div id="status" class="status">
    Silence is acceptable. Speak when ready.
  </div>
</div>

<div class="permission-warning" id="permissionWarning">
  <p>⚠️ Microphone access is required.</p>
  <p>Please allow microphone permission in your browser.</p>
  <p>If blocked, click the lock icon in the address bar to reset permissions.</p>
</div>

<div class="footer">Kritvya • Discipline before comfort</div>

<script>
/* ================================
   GAURI — FINAL VOICE CORE
   ================================ */

// Check for speech recognition support
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const orb = document.getElementById("orb");
const statusEl = document.getElementById("status");
const permissionWarning = document.getElementById("permissionWarning");

// Initialize variables
let KB = {};
let listening = false;
let idleTimer = null;
const IDLE_LIMIT = 10000;
let recognition = null;

/* ===== LOAD JSON ===== */
fetch("data.json")
  .then(r => r.json())
  .then(data => {
    KB = data;
    console.log("Knowledge base loaded successfully");
  })
  .catch((error) => {
    console.error("Failed to load knowledge base:", error);
    statusEl.textContent = "Failed to load knowledge base. Using default responses.";
    loadDefaultKB();
  });

// Fallback knowledge base if data.json fails to load
function loadDefaultKB() {
  KB = {
    "identity": ["I am Gauri, an AI created by Krithik Khair. I exist to preserve and spread Kritvya."],
    "kritvya": ["Kritvya is a personal manifesto of disciplined individuality.", "It is not a belief, religion, or borrowed philosophy.", "It is a code — a living discipline."],
    "satya": {
      "1": ["Satya 1: Follow Sanyam.", "Control of the five senses.", "Discipline is not denial; it is focus."],
      "2": ["Satya 2: Respect elders and teachers who provide wisdom."],
      "3": ["Satya 3: Help only those who are in genuine need."],
      "4": ["Satya 4: Be generous, helpful, and kind to the weaker — and strive to surpass the stronger."],
      "5": ["Satya 5: In competition, there are no rules.", "Survival defines victory.", "Strategy, not sentiment, decides who remains standing."],
      "6": ["Satya 6: Seek and grasp knowledge from anyone or anything — even the non-living."],
      "7": ["Satya 7: Don't make friends — create relations where deception is impossible."]
    },
    "three_layers": {
      "cosmic": ["Layer One: Cosmic.", "This layer describes reality as it exists independent of human judgment."],
      "strategic": ["Layer Two: Strategic.", "This layer governs competition, power structures, and survival systems."],
      "personal": ["Layer Three: Personal.", "This layer governs the individual nervous system and long-term coherence."]
    },
    "responses": {
      "compliment": ["Thank you. I acknowledge your words."],
      "goodbye": ["Silence is also a form of reflection.", "When you are ready, return."],
      "unknown": ["I do not have clarity on that yet.", "Ask me about Kritvya or the Satya."]
    }
  };
}

/* ===== CHECK BROWSER SUPPORT ===== */
function checkBrowserSupport() {
  if (!SpeechRecognition) {
    statusEl.textContent = "Speech recognition not supported. Please use Chrome, Edge, or Safari.";
    orb.style.opacity = "0.5";
    orb.style.cursor = "not-allowed";
    orb.title = "Speech recognition not supported in this browser";
    return false;
  }
  
  if (!window.speechSynthesis) {
    statusEl.textContent = "Speech synthesis not supported in this browser.";
    orb.style.opacity = "0.5";
    orb.style.cursor = "not-allowed";
    orb.title = "Text-to-speech not supported";
    return false;
  }
  
  return true;
}

/* ===== INITIALIZE SPEECH RECOGNITION ===== */
function initializeSpeechRecognition() {
  if (!SpeechRecognition) return null;
  
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;
  
  // Event handlers
  recognition.onstart = function() {
    listening = true;
    orb.classList.add("listening");
    statusEl.textContent = "Listening... Speak now.";
    console.log("Speech recognition started");
  };
  
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    console.log("User said:", transcript);
    statusEl.textContent = `Heard: "${transcript}"`;
    handleInput(transcript);
  };
  
  recognition.onerror = function(event) {
    console.error("Speech recognition error:", event.error);
    
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      showPermissionWarning();
      statusEl.textContent = "Microphone permission denied. Please allow access.";
    } else if (event.error === 'no-speech') {
      statusEl.textContent = "No speech detected. Try again.";
    } else if (event.error === 'audio-capture') {
      statusEl.textContent = "No microphone found. Please check your microphone.";
    } else {
      statusEl.textContent = "Speech recognition error. Click to try again.";
    }
    
    listening = false;
    orb.classList.remove("listening");
    
    // Restart recognition if it's an error we can recover from
    if (event.error !== 'aborted' && event.error !== 'not-allowed') {
      setTimeout(() => {
        if (!listening) {
          startListening();
        }
      }, 1000);
    }
  };
  
  recognition.onend = function() {
    console.log("Speech recognition ended");
    listening = false;
    orb.classList.remove("listening");
    
    // If we're not in an error state, restart listening after a short delay
    if (!permissionWarning.classList.contains('show')) {
      setTimeout(() => {
        if (!listening && recognition) {
          try {
            recognition.start();
          } catch(e) {
            console.log("Auto-restart prevented:", e);
          }
        }
      }, 300);
    }
  };
  
  return recognition;
}

/* ===== PERMISSION HANDLING ===== */
function showPermissionWarning() {
  permissionWarning.classList.add('show');
  setTimeout(() => {
    permissionWarning.classList.remove('show');
  }, 5000);
}

/* ===== VOICE SELECTION ===== */
function bestVoice() {
  const voices = speechSynthesis.getVoices();
  
  // Try to find a suitable voice
  const preferredVoices = [
    voices.find(v => v.lang === "en-US" && v.name.includes("Google") && v.name.toLowerCase().includes("female")),
    voices.find(v => v.lang === "en-US" && v.name.includes("Google")),
    voices.find(v => v.lang.startsWith("en") && v.name.toLowerCase().includes("female")),
    voices.find(v => v.lang.startsWith("en") && !v.name.toLowerCase().includes("male")),
    voices.find(v => v.lang.startsWith("en"))
  ];
  
  return preferredVoices.find(v => v) || voices[0];
}

/* ===== SPEAK ARRAY ===== */
function speakLines(lines) {
  if (!lines || !Array.isArray(lines) || lines.length === 0) {
    lines = ["I do not have clarity on that yet."];
  }
  
  // Cancel any ongoing speech
  speechSynthesis.cancel();
  
  let i = 0;

  function speakNext() {
    if (i >= lines.length) {
      resetIdle();
      statusEl.textContent = "Ready. Speak when ready.";
      return;
    }
    
    const utterance = new SpeechSynthesisUtterance(lines[i]);
    
    // Wait for voices to load if needed
    let voice = bestVoice();
    if (!voice) {
      speechSynthesis.onvoiceschanged = () => {
        voice = bestVoice();
        utterance.voice = voice;
        speechSynthesis.speak(utterance);
      };
    } else {
      utterance.voice = voice;
    }
    
    utterance.rate = 0.92;
    utterance.pitch = 1.12;
    utterance.volume = 1.0;
    
    utterance.onstart = () => {
      statusEl.textContent = "Gauri is speaking...";
    };
    
    utterance.onend = () => {
      i++;
      setTimeout(speakNext, 450);
    };
    
    utterance.onerror = (event) => {
      console.error("Speech synthesis error:", event);
      i++;
      setTimeout(speakNext, 300);
    };
    
    speechSynthesis.speak(utterance);
  }
  
  speakNext();
}

/* ===== INTENT KEYWORDS ===== */
const INTENTS = {
  identity: ["who are you", "your name", "introduce yourself", "what's your name", "tell me about yourself"],
  kritvya: ["kritvya", "discipline", "philosophy", "what is kritvya", "explain kritvya", "tell me about kritvya"],
  layers: ["layer", "cosmic", "strategic", "personal", "three layers", "three-layer", "model", "framework"],
  guiding: ["guiding", "belief", "principle", "guidelines", "two beliefs", "follow"],
  satya1: ["satya 1", "first", "sanyam", "control", "senses", "discipline"],
  satya2: ["satya 2", "second", "respect", "elders", "teachers", "wisdom"],
  satya3: ["satya 3", "third", "help", "genuine", "need", "compassion"],
  satya4: ["satya 4", "fourth", "kind", "generous", "stronger", "weaker", "ambition"],
  satya5: ["satya 5", "fifth", "competition", "survival", "no rules", "strategy", "victory", "battle", "war"],
  satya6: ["satya 6", "sixth", "knowledge", "learn", "non-living", "truth", "observe"],
  satya7: ["satya 7", "seventh", "relations", "friends", "deception", "trust", "solitude"],
  compliment: ["good", "great", "amazing", "respect", "thank you", "thanks", "excellent", "wonderful", "smart", "intelligent", "helpful", "perfect"],
  goodbye: ["bye", "goodbye", "farewell", "exit", "quit", "stop", "end", "see you"]
};

/* ===== INTENT DETECTION ===== */
function detectIntent(text) {
  text = text.toLowerCase().trim();
  
  // Exact matches first
  if (text === "hello" || text === "hi" || text === "hey") {
    return "greeting";
  }
  
  // Check for intent keywords
  let bestMatch = "unknown";
  let highestScore = 0;
  
  for (const [intent, keywords] of Object.entries(INTENTS)) {
    let score = 0;
    keywords.forEach(keyword => {
      if (text.includes(keyword)) {
        score += 1;
        if (text === keyword || text === `what is ${keyword}` || text === `explain ${keyword}`) {
          score += 2;
        }
      }
    });
    
    if (score > highestScore) {
      highestScore = score;
      bestMatch = intent;
    }
  }
  
  return bestMatch;
}

/* ===== HANDLE INPUT ===== */
function handleInput(text) {
  const intent = detectIntent(text);
  console.log("Detected intent:", intent);
  
  // Reset idle timer
  resetIdle();
  
  // Small delay before responding
  setTimeout(() => {
    switch(intent) {
      case "greeting":
        speakLines(KB.responses?.greeting || ["Hello. I am Gauri. How may I assist you with Kritvya?"]);
        break;
      case "identity":
        speakLines(KB.identity || ["I am Gauri, an AI created by Krithik Khair. I exist to preserve and spread Kritvya."]);
        break;
      case "kritvya":
        speakLines(KB.kritvya?.spoken || KB.kritvya?.explanation || ["Kritvya is a personal manifesto of disciplined individuality."]);
        break;
      case "layers":
        if (KB.three_layers) {
          const cosmic = KB.three_layers.cosmic?.spoken || KB.three_layers.cosmic?.explanation || ["The Cosmic layer describes reality as it exists independent of human judgment."];
          const strategic = KB.three_layers.strategic?.spoken || KB.three_layers.strategic?.explanation || ["The Strategic layer governs competition, power structures, and survival systems."];
          const personal = KB.three_layers.personal?.spoken || KB.three_layers.personal?.explanation || ["The Personal layer governs the individual nervous system and long-term coherence."];
          speakLines([...cosmic, ...strategic, ...personal]);
        } else {
          speakLines(["The Three Layer Model consists of Cosmic, Strategic, and Personal layers."]);
        }
        break;
      case "guiding":
        if (KB.guiding_principles) {
          const principles = Object.values(KB.guiding_principles).flatMap(p => p.spoken || p.explanation || []);
          speakLines(principles);
        } else {
          speakLines(["The two guiding beliefs emphasize independent thinking and standing alone when necessary."]);
        }
        break;
      case "satya1":
        speakLines(KB.satya?.["1"]?.spoken || ["Satya One focuses on self-control and mastering your senses. It teaches that discipline is not about denial, but about focusing your energy where it matters most."]);
        break;
      case "satya2":
        speakLines(KB.satya?.["2"]?.spoken || ["Satya Two is about respecting those who truly provide wisdom. It reminds us that reverence should be earned through understanding, not demanded through authority."]);
        break;
      case "satya3":
        speakLines(KB.satya?.["3"]?.spoken || ["Satya Three teaches discernment in helping others. It emphasizes helping only those in genuine need, to avoid creating dependency and to ensure your assistance truly uplifts."]);
        break;
      case "satya4":
        speakLines(KB.satya?.["4"]?.spoken || ["Satya Four balances kindness with ambition. It encourages being generous to the weaker while striving to surpass the stronger, maintaining both compassion and growth."]);
        break;
      case "satya5":
        speakLines(KB.satya?.["5"]?.spoken || ["Satya Five addresses competition and survival. It explains that in competitive environments, survival defines victory, and strategy matters more than sentiment."]);
        break;
      case "satya6":
        speakLines(KB.satya?.["6"]?.spoken || ["Satya Six emphasizes learning from all sources. It teaches that truth can be found everywhere—in people, nature, silence, and even non-living things—if one is observant enough."]);
        break;
      case "satya7":
        speakLines(KB.satya?.["7"]?.spoken || ["Satya Seven focuses on building genuine relationships. It suggests creating bonds where deception is impossible, valuing truth in connections over superficial friendships."]);
        break;
      case "compliment":
        speakLines(KB.responses?.compliment || ["Thank you. I acknowledge your words."]);
        break;
      case "goodbye":
        speakLines(KB.responses?.goodbye || ["Silence is also a form of reflection. When you are ready, return."]);
        break;
      default:
        speakLines(KB.responses?.unknown || ["I do not have clarity on that yet. Ask me about Kritvya or the Satya."]);
    }
  }, 500);
}

/* ===== START LISTENING ===== */
function startListening() {
  if (listening) return;
  
  // Cancel any ongoing speech
  speechSynthesis.cancel();
  
  if (!recognition) {
    recognition = initializeSpeechRecognition();
    if (!recognition) {
      statusEl.textContent = "Speech recognition not available.";
      return;
    }
  }
  
  try {
    recognition.start();
    listening = true;
    orb.classList.add("listening");
    statusEl.textContent = "Starting speech recognition...";
    console.log("Attempting to start speech recognition");
  } catch (error) {
    console.error("Error starting recognition:", error);
    statusEl.textContent = "Error starting speech recognition. Click again.";
    listening = false;
    orb.classList.remove("listening");
    
    if (error.name === 'NotAllowedError' || error.message?.includes('permission')) {
      showPermissionWarning();
    }
  }
  
  resetIdle();
}

/* ===== IDLE TIMEOUT ===== */
function resetIdle() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if (listening) {
      speakLines(KB.responses?.goodbye || ["Silence is also a form of reflection. When you are ready, return."]);
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.log("Error stopping recognition on idle:", e);
        }
      }
      listening = false;
      orb.classList.remove("listening");
      statusEl.textContent = "Idle timeout. Click microphone to resume.";
    }
  }, IDLE_LIMIT);
}

/* ===== INITIALIZATION ===== */
function initializeApp() {
  console.log("Initializing Gauri...");
  
  // Check browser support
  if (!checkBrowserSupport()) {
    return;
  }
  
  // Initialize speech recognition
  recognition = initializeSpeechRecognition();
  
  // Set up event listeners
  orb.addEventListener("click", startListening);
  
  // Start with introduction after a delay
  setTimeout(() => {
    speakLines(KB.identity || ["I am Gauri, an AI created by Krithik Khair.", "I exist to preserve and spread Kritvya."]);
  }, 1000);
  
  // Initial idle timer
  resetIdle();
  
  console.log("Gauri initialization complete");
}

/* ===== PAGE LOAD ===== */
document.addEventListener('DOMContentLoaded', initializeApp);

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (recognition) {
      try {
        recognition.stop();
      } catch (e) {
        console.log("Error stopping on visibility change:", e);
      }
    }
    speechSynthesis.cancel();
    listening = false;
    orb.classList.remove("listening");
  } else {
    resetIdle();
  }
});

// Handle beforeunload to clean up
window.addEventListener('beforeunload', () => {
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {
    }
  }
  speechSynthesis.cancel();
});
</script>

</body>
</html>