<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gauri • Kritvya</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: radial-gradient(circle at bottom, #0b1a2b, #050505 60%);
  color: #cfcfcf;
  font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  padding: 20px;
}

.header {
  position: absolute;
  top: 18px;
  width: 100%;
  text-align: center;
  font-size: 0.7rem;
  letter-spacing: 0.35em;
  color: #6f86a6;
}

.app {
  text-align: center;
  width: 100%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 30px;
}

.main-content {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  justify-content: center;
  gap: 30px;
  width: 100%;
}

@media (max-width: 768px) {
  .main-content {
    flex-direction: column;
    align-items: center;
  }
}

.orb-section {
  flex: 1;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.orb-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 40px;
}

.orb {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #5aa9ff, #1b3c66 70%);
  box-shadow: 0 0 50px rgba(90,169,255,0.25);
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.orb:hover {
  transform: scale(1.05);
  box-shadow: 0 0 70px rgba(90,169,255,0.35);
}

.orb.listening {
  animation: pulse 2.2s infinite;
  box-shadow: 0 0 80px rgba(120,180,255,0.45);
  background: radial-gradient(circle at 30% 30%, #ff5a5a, #661b1b 70%);
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.06); }
  100% { transform: scale(1); }
}

.questions-guide {
  flex: 1;
  max-width: 400px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  max-height: 500px;
  overflow-y: auto;
}

.guide-header {
  font-size: 0.9rem;
  color: #6f86a6;
  margin-bottom: 20px;
  text-align: center;
  letter-spacing: 0.1em;
  border-bottom: 1px solid rgba(111, 134, 166, 0.3);
  padding-bottom: 10px;
}

.question-category {
  margin-bottom: 20px;
}

.category-title {
  font-size: 0.85rem;
  color: #8fa3c2;
  margin-bottom: 10px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.category-title::before {
  content: "•";
  color: #5aa9ff;
}

.question-list {
  list-style: none;
  padding-left: 15px;
}

.question-item {
  font-size: 0.8rem;
  color: #a0b3d1;
  margin-bottom: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
  border-left: 2px solid rgba(90, 169, 255, 0.3);
  transition: all 0.2s ease;
  cursor: default;
}

.question-item:hover {
  background: rgba(90, 169, 255, 0.1);
  border-left: 2px solid #5aa9ff;
  transform: translateX(5px);
}

.status {
  margin-top: 25px;
  font-size: 0.95rem;
  color: #9aa8bd;
  min-height: 40px;
  padding: 0 16px;
  width: 100%;
  text-align: center;
}

.footer {
  position: absolute;
  bottom: 24px;
  width: 100%;
  text-align: center;
  font-size: 0.75rem;
  color: #5f6f85;
}

.permission-warning {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  padding: 20px;
  border-radius: 10px;
  border: 1px solid #5aa9ff;
  max-width: 80%;
  z-index: 100;
  display: none;
}

.permission-warning.show {
  display: block;
}

/* Custom scrollbar for questions guide */
.questions-guide::-webkit-scrollbar {
  width: 6px;
}

.questions-guide::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

.questions-guide::-webkit-scrollbar-thumb {
  background: rgba(90, 169, 255, 0.3);
  border-radius: 3px;
}

.questions-guide::-webkit-scrollbar-thumb:hover {
  background: rgba(90, 169, 255, 0.5);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  body {
    padding: 10px;
    height: auto;
    min-height: 100vh;
    overflow-y: auto;
  }
  
  .app {
    margin-top: 40px;
    margin-bottom: 60px;
  }
  
  .orb-section, .questions-guide {
    width: 100%;
    max-width: 100%;
  }
  
  .questions-guide {
    max-height: 400px;
  }
  
  .footer {
    position: relative;
    bottom: auto;
    margin-top: 30px;
    margin-bottom: 20px;
  }
}

@media (max-height: 700px) {
  .questions-guide {
    max-height: 300px;
  }
}
</style>
</head>

<body>

<div class="header">GAURI • LIVE</div>

<div class="app">
  <div class="main-content">
    <div class="orb-section">
      <div class="orb-wrapper">
        <div id="orb" class="orb"></div>
      </div>
      <div id="status" class="status">
        Silence is acceptable. Speak when ready.
      </div>
    </div>
    
    <div class="questions-guide">
      <div class="guide-header">QUESTIONS TO ASK GAURI</div>
      
      <div class="question-category">
        <div class="category-title">IDENTITY & PURPOSE</div>
        <ul class="question-list">
          <li class="question-item">"Who are you?"</li>
          <li class="question-item">"What is your purpose?"</li>
          <li class="question-item">"Tell me about yourself"</li>
          <li class="question-item">"Who created you?"</li>
          <li class="question-item">"Introduce yourself"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">KRITVYA PHILOSOPHY</div>
        <ul class="question-list">
          <li class="question-item">"What is Kritvya?"</li>
          <li class="question-item">"Explain Kritvya philosophy"</li>
          <li class="question-item">"What does Kritvya mean?"</li>
          <li class="question-item">"Tell me about Kritvya"</li>
          <li class="question-item">"What is the purpose of Kritvya?"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">THREE LAYER MODEL</div>
        <ul class="question-list">
          <li class="question-item">"Explain the three layers"</li>
          <li class="question-item">"What is the cosmic layer?"</li>
          <li class="question-item">"What is the strategic layer?"</li>
          <li class="question-item">"What is the personal layer?"</li>
          <li class="question-item">"Tell me about the three-layer model"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">SEVEN SATYA</div>
        <ul class="question-list">
          <li class="question-item">"Explain Satya 1"</li>
          <li class="question-item">"What is Satya 2?"</li>
          <li class="question-item">"Tell me about Satya 3"</li>
          <li class="question-item">"Explain Satya 4"</li>
          <li class="question-item">"What is Satya 5?"</li>
          <li class="question-item">"Tell me about Satya 6"</li>
          <li class="question-item">"Explain Satya 7"</li>
          <li class="question-item">"What are the Seven Satya?"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">GUIDING PRINCIPLES</div>
        <ul class="question-list">
          <li class="question-item">"What are the guiding beliefs?"</li>
          <li class="question-item">"Explain the two principles"</li>
          <li class="question-item">"What should I not follow?"</li>
          <li class="question-item">"Tell me about the guiding principles"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">DETAILED SATYA 5</div>
        <ul class="question-list">
          <li class="question-item">"Explain Satya 5 in detail"</li>
          <li class="question-item">"What are the five rules of Satya 5?"</li>
          <li class="question-item">"Explain domain lock rule"</li>
          <li class="question-item">"What is leverage over force?"</li>
          <li class="question-item">"Explain identity audit"</li>
          <li class="question-item">"What is exit strategy?"</li>
          <li class="question-item">"Explain power capacity check"</li>
          <li class="question-item">"How to apply Satya 5?"</li>
        </ul>
      </div>
      
      <div class="question-category">
        <div class="category-title">GENERAL</div>
        <ul class="question-list">
          <li class="question-item">"Hello" / "Hi"</li>
          <li class="question-item">"Goodbye" / "Bye"</li>
          <li class="question-item">"Thank you"</li>
          <li class="question-item">"You're helpful"</li>
          <li class="question-item">"What can you teach me?"</li>
          <li class="question-item">"Help me understand Kritvya"</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="permission-warning" id="permissionWarning">
  <p>⚠️ Microphone access is required.</p>
  <p>Please allow microphone permission in your browser.</p>
  <p>If blocked, click the lock icon in the address bar to reset permissions.</p>
</div>

<div class="footer">Kritvya • Discipline before comfort</div>

<script>
/* ================================
   GAURI — FINAL VOICE CORE
   ================================ */

// Check for speech recognition support
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const orb = document.getElementById("orb");
const statusEl = document.getElementById("status");
const permissionWarning = document.getElementById("permissionWarning");

// Initialize variables
let KB = {};
let listening = false;
let idleTimer = null;
const IDLE_LIMIT = 10000;
let recognition = null;

/* ===== LOAD JSON ===== */
fetch("data.json")
  .then(r => r.json())
  .then(data => {
    KB = data;
    console.log("Knowledge base loaded successfully");
  })
  .catch((error) => {
    console.error("Failed to load knowledge base:", error);
    statusEl.textContent = "Failed to load knowledge base. Using default responses.";
    loadDefaultKB();
  });

// Fallback knowledge base if data.json fails to load
function loadDefaultKB() {
  KB = {
    "identity": ["I am Gauri, an AI created by Krithik Khair. I exist to preserve and spread Kritvya."],
    "kritvya": ["Kritvya is a personal manifesto of disciplined individuality.", "It is not a belief, religion, or borrowed philosophy.", "It is a code — a living discipline."],
    "satya": {
      "1": ["Satya 1: Follow Sanyam.", "Control of the five senses.", "Discipline is not denial; it is focus."],
      "2": ["Satya 2: Respect elders and teachers who provide wisdom."],
      "3": ["Satya 3: Help only those who are in genuine need."],
      "4": ["Satya 4: Be generous, helpful, and kind to the weaker — and strive to surpass the stronger."],
      "5": ["Satya 5: In competition, there are no rules.", "Survival defines victory.", "Strategy, not sentiment, decides who remains standing."],
      "6": ["Satya 6: Seek and grasp knowledge from anyone or anything — even the non-living."],
      "7": ["Satya 7: Don't make friends — create relations where deception is impossible."]
    },
    "three_layers": {
      "cosmic": ["Layer One: Cosmic.", "This layer describes reality as it exists independent of human judgment."],
      "strategic": ["Layer Two: Strategic.", "This layer governs competition, power structures, and survival systems."],
      "personal": ["Layer Three: Personal.", "This layer governs the individual nervous system and long-term coherence."]
    },
    "responses": {
      "greeting": ["Hello. I am Gauri. How may I assist you with Kritvya?"],
      "compliment": ["Thank you. I acknowledge your words."],
      "goodbye": ["Silence is also a form of reflection.", "When you are ready, return."],
      "unknown": ["I do not have clarity on that yet.", "Ask me about Kritvya or the Satya."]
    }
  };
}

/* ===== CHECK BROWSER SUPPORT ===== */
function checkBrowserSupport() {
  if (!SpeechRecognition) {
    statusEl.textContent = "Speech recognition not supported. Please use Chrome, Edge, or Safari.";
    orb.style.opacity = "0.5";
    orb.style.cursor = "not-allowed";
    orb.title = "Speech recognition not supported in this browser";
    return false;
  }
  
  if (!window.speechSynthesis) {
    statusEl.textContent = "Speech synthesis not supported in this browser.";
    orb.style.opacity = "0.5";
    orb.style.cursor = "not-allowed";
    orb.title = "Text-to-speech not supported";
    return false;
  }
  
  return true;
}

/* ===== INITIALIZE SPEECH RECOGNITION ===== */
function initializeSpeechRecognition() {
  if (!SpeechRecognition) return null;
  
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;
  
  // Event handlers
  recognition.onstart = function() {
    listening = true;
    orb.classList.add("listening");
    statusEl.textContent = "Listening... Speak now.";
    console.log("Speech recognition started");
  };
  
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    console.log("User said:", transcript);
    statusEl.textContent = `Heard: "${transcript}"`;
    handleInput(transcript);
  };
  
  recognition.onerror = function(event) {
    console.error("Speech recognition error:", event.error);
    
    if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
      showPermissionWarning();
      statusEl.textContent = "Microphone permission denied. Please allow access.";
    } else if (event.error === 'no-speech') {
      statusEl.textContent = "No speech detected. Try again.";
    } else if (event.error === 'audio-capture') {
      statusEl.textContent = "No microphone found. Please check your microphone.";
    } else {
      statusEl.textContent = "Speech recognition error. Click to try again.";
    }
    
    listening = false;
    orb.classList.remove("listening");
    
    // Restart recognition if it's an error we can recover from
    if (event.error !== 'aborted' && event.error !== 'not-allowed') {
      setTimeout(() => {
        if (!listening) {
          startListening();
        }
      }, 1000);
    }
  };
  
  recognition.onend = function() {
    console.log("Speech recognition ended");
    listening = false;
    orb.classList.remove("listening");
    
    // If we're not in an error state, restart listening after a short delay
    if (!permissionWarning.classList.contains('show')) {
      setTimeout(() => {
        if (!listening && recognition) {
          try {
            recognition.start();
          } catch(e) {
            console.log("Auto-restart prevented:", e);
          }
        }
      }, 300);
    }
  };
  
  return recognition;
}

/* ===== PERMISSION HANDLING ===== */
function showPermissionWarning() {
  permissionWarning.classList.add('show');
  setTimeout(() => {
    permissionWarning.classList.remove('show');
  }, 5000);
}

/* ===== VOICE SELECTION - FEMALE ONLY ===== */
function getFemaleVoice() {
  const voices = speechSynthesis.getVoices();
  
  // Filter for female voices only
  const femaleVoices = voices.filter(voice => {
    // Check for female indicators in voice name
    const voiceName = voice.name.toLowerCase();
    return (
      voiceName.includes('female') ||
      voiceName.includes('woman') ||
      voiceName.includes('girl') ||
      voiceName.includes('samantha') ||
      voiceName.includes('zira') ||
      voiceName.includes('ava') ||
      voiceName.includes('karen') ||
      voiceName.includes('serena') ||
      voiceName.includes('veena') ||
      voiceName.includes('tessa') ||
      voiceName.includes('melina') ||
      voiceName.includes('natalia') ||
      voiceName.includes('yuri') ||
      (voiceName.includes('google') && voiceName.includes('female')) ||
      (voiceName.includes('microsoft') && voiceName.includes('female'))
    );
  });
  
  // If no specifically marked female voices, use voices that sound female
  if (femaleVoices.length === 0) {
    // These are known female voice names across different platforms
    const knownFemaleVoiceNames = [
      'Samantha', 'Karen', 'Tessa', 'Serena', 'Veena',
      'Melina', 'Yuri', 'Natalia', 'Zira', 'Ava',
      'Microsoft Zira Desktop', 'Google US English Female',
      'Microsoft Hazel Desktop', 'Microsoft Haruka Desktop'
    ];
    
    for (const voice of voices) {
      if (knownFemaleVoiceNames.includes(voice.name)) {
        return voice;
      }
    }
  }
  
  // Return first female voice if found
  if (femaleVoices.length > 0) {
    // Prioritize natural-sounding voices
    const naturalVoices = femaleVoices.filter(v => 
      !v.name.toLowerCase().includes('compact') && 
      !v.name.toLowerCase().includes('enhanced')
    );
    return naturalVoices.length > 0 ? naturalVoices[0] : femaleVoices[0];
  }
  
  // If absolutely no female voice found, return null (we'll handle this in speakLines)
  return null;
}

/* ===== SPEAK ARRAY ===== */
function speakLines(lines) {
  if (!lines || !Array.isArray(lines) || lines.length === 0) {
    lines = ["I do not have clarity on that yet."];
  }
  
  // Cancel any ongoing speech
  speechSynthesis.cancel();
  
  let i = 0;

  function speakNext() {
    if (i >= lines.length) {
      resetIdle();
      statusEl.textContent = "Ready. Speak when ready.";
      return;
    }
    
    const utterance = new SpeechSynthesisUtterance(lines[i]);
    
    // Get female voice only
    let voice = getFemaleVoice();
    
    // If no female voice found, wait for voices to load and try again
    if (!voice) {
      speechSynthesis.onvoiceschanged = () => {
        voice = getFemaleVoice();
        if (voice) {
          utterance.voice = voice;
          utterance.rate = 0.92;
          utterance.pitch = 1.1; // Slightly higher for female tone
          utterance.volume = 1.0;
          speechSynthesis.speak(utterance);
        } else {
          // If still no female voice after loading, use default but with higher pitch
          utterance.rate = 0.92;
          utterance.pitch = 1.2; // Higher pitch to sound more feminine
          utterance.volume = 1.0;
          speechSynthesis.speak(utterance);
        }
      };
      
      // Trigger voices changed event
      speechSynthesis.getVoices();
    } else {
      utterance.voice = voice;
      utterance.rate = 0.92;
      utterance.pitch = 1.1;
      utterance.volume = 1.0;
      speechSynthesis.speak(utterance);
    }
    
    utterance.onstart = () => {
      statusEl.textContent = "Gauri is speaking...";
    };
    
    utterance.onend = () => {
      i++;
      setTimeout(speakNext, 450);
    };
    
    utterance.onerror = (event) => {
      console.error("Speech synthesis error:", event);
      i++;
      setTimeout(speakNext, 300);
    };
  }
  
  speakNext();
}

/* ===== INTENT KEYWORDS ===== */
const INTENTS = {
  identity: ["who are you", "your name", "introduce yourself", "what's your name", "tell me about yourself", "what is your purpose", "who created you"],
  kritvya: ["kritvya", "discipline", "philosophy", "what is kritvya", "explain kritvya", "tell me about kritvya", "what does kritvya mean"],
  layers: ["layer", "cosmic", "strategic", "personal", "three layers", "three-layer", "model", "framework", "explain the three layers", "what is the cosmic layer", "what is the strategic layer", "what is the personal layer"],
  guiding: ["guiding", "belief", "principle", "guidelines", "two beliefs", "follow", "what are the guiding beliefs", "explain the two principles", "what should i not follow"],
  satya1: ["satya 1", "first", "sanyam", "control", "senses", "discipline", "explain satya 1", "what is satya 1"],
  satya2: ["satya 2", "second", "respect", "elders", "teachers", "wisdom", "explain satya 2", "what is satya 2"],
  satya3: ["satya 3", "third", "help", "genuine", "need", "compassion", "explain satya 3", "what is satya 3", "tell me about satya 3"],
  satya4: ["satya 4", "fourth", "kind", "generous", "stronger", "weaker", "ambition", "explain satya 4", "what is satya 4"],
  satya5: ["satya 5", "fifth", "competition", "survival", "no rules", "strategy", "victory", "battle", "war", "explain satya 5", "what is satya 5", "explain satya 5 in detail", "what are the five rules", "domain lock", "leverage over force", "identity audit", "exit strategy", "power capacity check", "how to apply satya 5"],
  satya6: ["satya 6", "sixth", "knowledge", "learn", "non-living", "truth", "observe", "explain satya 6", "what is satya 6"],
  satya7: ["satya 7", "seventh", "relations", "friends", "deception", "trust", "solitude", "explain satya 7", "what is satya 7"],
  all_satya: ["seven satya", "all satya", "what are the satya", "list the satya"],
  compliment: ["good", "great", "amazing", "respect", "thank you", "thanks", "excellent", "wonderful", "smart", "intelligent", "helpful", "perfect", "you're helpful", "good job"],
  goodbye: ["bye", "goodbye", "farewell", "exit", "quit", "stop", "end", "see you"],
  help: ["help", "what can you teach me", "help me understand", "what questions can i ask", "what can you explain"]
};

/* ===== INTENT DETECTION ===== */
function detectIntent(text) {
  text = text.toLowerCase().trim();
  
  // Exact matches first
  if (text === "hello" || text === "hi" || text === "hey") {
    return "greeting";
  }
  
  // Check for intent keywords
  let bestMatch = "unknown";
  let highestScore = 0;
  
  for (const [intent, keywords] of Object.entries(INTENTS)) {
    let score = 0;
    keywords.forEach(keyword => {
      if (text.includes(keyword)) {
        score += 1;
        if (text === keyword || text === `what is ${keyword}` || text === `explain ${keyword}`) {
          score += 2;
        }
      }
    });
    
    if (score > highestScore) {
      highestScore = score;
      bestMatch = intent;
    }
  }
  
  return bestMatch;
}

/* ===== HANDLE INPUT ===== */
function handleInput(text) {
  const intent = detectIntent(text);
  console.log("Detected intent:", intent);
  
  // Reset idle timer
  resetIdle();
  
  // Small delay before responding
  setTimeout(() => {
    switch(intent) {
      case "greeting":
        speakLines(KB.responses?.greeting || ["Hello. I am Gauri. How may I assist you with Kritvya?"]);
        break;
      case "identity":
        speakLines(KB.identity || ["I am Gauri, an AI created by Krithik Khair. I exist to preserve and spread Kritvya."]);
        break;
      case "kritvya":
        speakLines(KB.kritvya?.spoken || KB.kritvya?.explanation || ["Kritvya is a personal manifesto of disciplined individuality."]);
        break;
      case "layers":
        if (KB.three_layers) {
          const cosmic = KB.three_layers.cosmic?.spoken || KB.three_layers.cosmic?.explanation || ["The Cosmic layer describes reality as it exists independent of human judgment."];
          const strategic = KB.three_layers.strategic?.spoken || KB.three_layers.strategic?.explanation || ["The Strategic layer governs competition, power structures, and survival systems."];
          const personal = KB.three_layers.personal?.spoken || KB.three_layers.personal?.explanation || ["The Personal layer governs the individual nervous system and long-term coherence."];
          speakLines([...cosmic, ...strategic, ...personal]);
        } else {
          speakLines(["The Three Layer Model consists of Cosmic, Strategic, and Personal layers."]);
        }
        break;
      case "guiding":
        if (KB.guiding_principles) {
          const principles = Object.values(KB.guiding_principles).flatMap(p => p.spoken || p.explanation || []);
          speakLines(principles);
        } else {
          speakLines(["The two guiding beliefs emphasize independent thinking and standing alone when necessary."]);
        }
        break;
      case "satya1":
        speakLines(KB.satya?.["1"]?.spoken || ["Satya One focuses on self-control and mastering your senses. It teaches that discipline is not about denial, but about focusing your energy where it matters most."]);
        break;
      case "satya2":
        speakLines(KB.satya?.["2"]?.spoken || ["Satya Two is about respecting those who truly provide wisdom. It reminds us that reverence should be earned through understanding, not demanded through authority."]);
        break;
      case "satya3":
        speakLines(KB.satya?.["3"]?.spoken || ["Satya Three teaches discernment in helping others. It emphasizes helping only those in genuine need, to avoid creating dependency and to ensure your assistance truly uplifts."]);
        break;
      case "satya4":
        speakLines(KB.satya?.["4"]?.spoken || ["Satya Four balances kindness with ambition. It encourages being generous to the weaker while striving to surpass the stronger, maintaining both compassion and growth."]);
        break;
      case "satya5":
        speakLines(KB.satya?.["5"]?.spoken || ["Satya Five addresses competition and survival. It explains that in competitive environments, survival defines victory, and strategy matters more than sentiment."]);
        break;
      case "satya6":
        speakLines(KB.satya?.["6"]?.spoken || ["Satya Six emphasizes learning from all sources. It teaches that truth can be found everywhere—in people, nature, silence, and even non-living things—if one is observant enough."]);
        break;
      case "satya7":
        speakLines(KB.satya?.["7"]?.spoken || ["Satya Seven focuses on building genuine relationships. It suggests creating bonds where deception is impossible, valuing truth in connections over superficial friendships."]);
        break;
      case "all_satya":
        const allSatya = [];
        for (let i = 1; i <= 7; i++) {
          const satyaLines = KB.satya?.[i]?.spoken || [`Satya ${i} is part of the Kritvya principles.`];
          allSatya.push(...satyaLines);
          allSatya.push(""); // Empty line between Satya
        }
        speakLines(allSatya);
        break;
      case "compliment":
        speakLines(KB.responses?.compliment || ["Thank you. I acknowledge your words."]);
        break;
      case "goodbye":
        speakLines(KB.responses?.goodbye || ["Silence is also a form of reflection. When you are ready, return."]);
        break;
      case "help":
        speakLines(["You can ask me about Kritvya philosophy, the Seven Satya, the Three Layer Model, or specific aspects of disciplined individuality.", "Look at the questions guide for specific examples of what to ask."]);
        break;
      default:
        speakLines(KB.responses?.unknown || ["I do not have clarity on that yet. Ask me about Kritvya or the Satya. You can refer to the questions guide for ideas."]);
    }
  }, 500);
}

/* ===== START LISTENING ===== */
function startListening() {
  if (listening) return;
  
  // Cancel any ongoing speech
  speechSynthesis.cancel();
  
  if (!recognition) {
    recognition = initializeSpeechRecognition();
    if (!recognition) {
      statusEl.textContent = "Speech recognition not available.";
      return;
    }
  }
  
  try {
    recognition.start();
    listening = true;
    orb.classList.add("listening");
    statusEl.textContent = "Starting speech recognition...";
    console.log("Attempting to start speech recognition");
  } catch (error) {
    console.error("Error starting recognition:", error);
    statusEl.textContent = "Error starting speech recognition. Click again.";
    listening = false;
    orb.classList.remove("listening");
    
    if (error.name === 'NotAllowedError' || error.message?.includes('permission')) {
      showPermissionWarning();
    }
  }
  
  resetIdle();
}

/* ===== IDLE TIMEOUT ===== */
function resetIdle() {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if (listening) {
      speakLines(KB.responses?.goodbye || ["Silence is also a form of reflection. When you are ready, return."]);
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.log("Error stopping recognition on idle:", e);
        }
      }
      listening = false;
      orb.classList.remove("listening");
      statusEl.textContent = "Idle timeout. Click microphone to resume.";
    }
  }, IDLE_LIMIT);
}

/* ===== INITIALIZATION ===== */
function initializeApp() {
  console.log("Initializing Gauri...");
  
  // Check browser support
  if (!checkBrowserSupport()) {
    return;
  }
  
  // Initialize speech recognition
  recognition = initializeSpeechRecognition();
  
  // Set up event listeners
  orb.addEventListener("click", startListening);
  
  // Start with introduction after a delay
  setTimeout(() => {
    speakLines(KB.identity || ["I am Gauri, an AI created by Krithik Khair.", "I exist to preserve and spread Kritvya."]);
  }, 1000);
  
  // Initial idle timer
  resetIdle();
  
  console.log("Gauri initialization complete");
}

/* ===== PAGE LOAD ===== */
document.addEventListener('DOMContentLoaded', initializeApp);

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (recognition) {
      try {
        recognition.stop();
      } catch (e) {
        console.log("Error stopping on visibility change:", e);
      }
    }
    speechSynthesis.cancel();
    listening = false;
    orb.classList.remove("listening");
  } else {
    resetIdle();
  }
});

// Handle beforeunload to clean up
window.addEventListener('beforeunload', () => {
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {
    }
  }
  speechSynthesis.cancel();
});
</script>

</body>
</html>